{"version":3,"sources":["../src/schema-generator.js"],"names":[],"mappings":"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","file":"schema-generator.js","sourcesContent":["import _ from 'underscore';\nimport SchemaChange from './schema-change';\nimport {format as fmt} from 'util';\n\nexport default class SchemaGenerator {\n  constructor(differ, options) {\n    this.differ = differ;\n    this.changes = differ.diff();\n    this.options = options != null ? options : {};\n    this.tableSchema = '';\n    this.tablePrefix = '';\n  }\n\n  generate() {\n    this.schemaChanges = _.flatten(_.map(this.transform(), this.statementForChange.bind(this)));\n    return this.schemaChanges;\n  }\n\n  transform() {\n    const changes = [];\n\n    if (this.options.beforeTransform) {\n      this.options.beforeTransform(this, changes);\n    }\n\n    const columnRenamesAndDrops = _.select(this.changes, function (change) {\n      return change.type === 'drop-column' || change.type === 'rename-column';\n    });\n\n    let tablesWithColumnDrops = _.map(columnRenamesAndDrops, function (change) {\n      return change.newTable;\n    });\n\n    tablesWithColumnDrops = _.uniq(tablesWithColumnDrops, false, function (table) {\n      return table.id;\n    });\n\n    const tablesIdentifiersWithColumnDrops = _.map(tablesWithColumnDrops, function (table) {\n      return table.id;\n    });\n\n    for (const change of this.changes) {\n      const isSimpleChange = _.contains(['add-column', 'drop-column', 'rename-column'], change.type);\n\n      const shouldReplaceWithRecreate = isSimpleChange && _.contains(tablesIdentifiersWithColumnDrops, change.newTable.id);\n\n      if (!shouldReplaceWithRecreate) {\n        changes.push(change);\n      }\n    }\n\n    const ids = [];\n\n    for (const drop of columnRenamesAndDrops) {\n      if (!_.contains(ids, drop.newTable.id)) {\n        changes.push(new SchemaChange('recreate-table', {oldTable: drop.oldTable, newTable: drop.newTable}));\n\n        ids.push(drop.newTable.id);\n      }\n    }\n\n    this.processIndexes(changes);\n\n    if (this.options.afterTransform) {\n      this.options.afterTransform(this, changes);\n    }\n\n    return changes;\n  }\n\n  statementForChange(change) {\n    switch (change.type) {\n      case 'create-table':\n        return this.createTable(change);\n      case 'recreate-table':\n        return this.recreateTable(change);\n      case 'drop-table':\n        return this.dropTable(change);\n      case 'add-column':\n        return this.addColumn(change);\n      case 'drop-column':\n        return this.dropColumn(change);\n      case 'rename-column':\n        return this.renameColumn(change);\n      case 'drop-view':\n        return this.dropView(change);\n      case 'create-view':\n        return this.createView(change);\n      case 'create-index':\n        return this.createIndex(change);\n      case 'raw':\n        return this.raw(change);\n      default:\n        throw new Error('Invalid change type ' + change.type);\n    }\n  }\n\n  escape(identifier) {\n    if (identifier == null || identifier.length === 0) {\n      return '';\n    }\n\n    return '\"' + (identifier.replace(/\"/g, '\"\"')) + '\"';\n  }\n\n  columnDefinition(column) {\n    return this.escape(column.name) + ' ' + this.typeForColumn(column) + this.columnModifiers(column);\n  }\n\n  columnModifiers(column) {\n    return column.allowNull ? '' : ' NOT NULL';\n  }\n\n  columnsForTable(table) {\n    return _.map(table.columns, this.columnDefinition.bind(this));\n  }\n\n  projectionForTable(table) {\n    return _.map(table.columns, function (column) {\n      return column.name;\n    });\n  }\n\n  projectionForView(view) {\n    const parts = [];\n\n    for (const reference of view.columns) {\n      parts.push(fmt('%s AS %s', this.escape(reference.column.name), this.escape(reference.alias)));\n    }\n\n    return parts;\n  }\n\n  mappingForTables(oldTable, newTable) {\n    const mappings = [];\n\n    for (const newColumn of newTable.columns) {\n      const oldColumn = _.find(oldTable.columns, function (column) {\n        return column.id === newColumn.id;\n      });\n\n      if (oldColumn) {\n        mappings.push({\n          oldColumn: oldColumn,\n          newColumn: newColumn\n        });\n      }\n    }\n\n    return mappings;\n  }\n\n  escapedSchema() {\n    if (this.tableSchema == null || this.tableSchema.length === 0) {\n      return '';\n    }\n\n    return this.escape(this.tableSchema) + '.';\n  }\n\n  createTable(change) {\n    return fmt('CREATE TABLE IF NOT EXISTS %s (%s);',\n               this.tableName(change.newTable),\n               this.columnsForTable(change.newTable).join(', '));\n  }\n\n  raw(change) {\n    return change.sql;\n  }\n\n  recreateTable(change) {\n    const newTableName = change.newTable.name;\n    const oldTableName = change.oldTable.name;\n\n    const newTemporaryTableName = 'tmp_new_' + newTableName;\n    const oldTemporaryTableName = 'tmp_old_' + oldTableName;\n\n    const parts = [];\n\n    parts.push(this.createTable({newTable: {name: newTemporaryTableName,\n                                            columns: change.newTable.columns}}));\n\n    parts.push(this.insertInto({name: newTemporaryTableName, columns: change.newTable.columns},\n                               change.oldTable));\n\n    parts.push(this.renameTable({oldTable: {name: oldTableName},\n                                 newTable: {name: oldTemporaryTableName}}));\n\n    parts.push(this.renameTable({oldTable: {name: newTemporaryTableName},\n                                 newTable: {name: newTableName}}));\n\n    parts.push(this.dropTable({oldTable: {name: oldTemporaryTableName}}));\n\n    return parts;\n  }\n\n  insertInto(into, from) {\n    const mappings = this.mappingForTables(from, into);\n\n    const newColumns = _.map(mappings, (pair) => {\n      return this.escape(pair.newColumn.name);\n    });\n\n    const oldColumns = _.map(mappings, (column) => {\n      // handle data type changes\n      if (column.oldColumn.type !== 'double' && column.newColumn.type === 'double') {\n        return this.transformToDouble(this.escape(column.oldColumn.name));\n      } else if (column.oldColumn.type === 'double' && column.newColumn.type !== 'double') {\n        return this.transformToText(this.escape(column.oldColumn.name));\n      } else {\n        return this.escape(column.oldColumn.name);\n      }\n    });\n\n    return fmt('INSERT INTO %s (%s) SELECT %s FROM %s;',\n               this.tableName(into),\n               newColumns.join(', '),\n               oldColumns.join(', '),\n               this.tableName(from));\n  }\n\n  renameTable(change) {\n    return fmt('ALTER TABLE %s RENAME TO %s;',\n               this.tableName(change.oldTable),\n               this.escape(this.tablePrefix + change.newTable.name));\n  }\n\n  dropTable(change) {\n    return fmt('DROP TABLE IF EXISTS %s;',\n               this.tableName(change.oldTable));\n  }\n\n  addColumn(change) {\n    return fmt('ALTER TABLE %s ADD COLUMN %s;',\n               this.tableName(change.newTable),\n               this.columnDefinition(change.column));\n  }\n\n  dropColumn(change) {\n    return fmt('ALTER TABLE %s DROP COLUMN %s;',\n               this.tableName(change.newTable),\n               this.escape(change.column));\n  }\n\n  renameColumn(change) {\n    return fmt('ALTER TABLE %s RENAME COLUMN %s TO %s;',\n               this.tableName(change.newTable),\n               this.escape(change.oldColumn.name),\n               this.escape(change.newColumn.name));\n  }\n\n  tableName(table) {\n    return this.escapedSchema() + this.escape(this.tablePrefix + table.name);\n  }\n\n  viewName(view) {\n    return this.escapedSchema() + this.escape(this.tablePrefix + view.table.name + '_view');\n  }\n\n  indexName(table, columns) {\n    return this.escape('idx_' + this.tablePrefix + table.name + '_' + columns.join('_'));\n  }\n\n  dropView(change) {\n    return fmt('DROP VIEW IF EXISTS %s;', this.viewName(change.oldView));\n  }\n\n  createView(change) {\n    return fmt('CREATE VIEW IF NOT EXISTS %s AS SELECT %s FROM %s;',\n               this.viewName(change.newView),\n               this.projectionForView(change.newView),\n               this.tableName(change.newView.table));\n  }\n\n  createIndex(change) {\n    return fmt('CREATE INDEX %s ON %s (%s);',\n               this.indexName(change.newTable, change.columns),\n               this.tableName(change.newTable),\n               change.columns.map(c => this.escape(c)).join(', '));\n  }\n\n  processIndexes(changes) {\n    for (const change of changes) {\n      if (_.contains(['create-table', 'recreate-table'], change.type)) {\n        for (const index of change.newTable.indexes) {\n          changes.push(new SchemaChange('create-index', {newTable: change.newTable,\n                                                         columns: index.columns,\n                                                         type: index.type,\n                                                         unique: !!index.unique}));\n        }\n      }\n    }\n  }\n}\n"]}