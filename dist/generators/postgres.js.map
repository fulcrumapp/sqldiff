{"version":3,"sources":["../../src/generators/postgres.js"],"names":[],"mappings":"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","file":"postgres.js","sourcesContent":["import SchemaGenerator from '../schema-generator';\nimport {format as fmt} from 'util';\n\n// This function is required in the database\n\n/*\nCREATE OR REPLACE FUNCTION convert_to_float(input_value text)\nRETURNS FLOAT AS $$\nDECLARE float_value FLOAT DEFAULT NULL;\nBEGIN\n  BEGIN\n    float_value := input_value::float;\n  EXCEPTION WHEN OTHERS THEN\n    RETURN NULL;\n  END;\nRETURN float_value;\nEND;\n$$ LANGUAGE plpgsql;\n*/\n\nconst TYPES = {\n  pk: 'bigserial NOT NULL',\n  string: 'text',\n  integer: 'bigint',\n  date: 'float',\n  double: 'double precision',\n  timestamp: 'timestamp without time zone',\n  geometry: 'geometry(Geometry, 4326)',\n  array: 'text[]',\n  boolean: 'boolean',\n  fts: 'tsvector'\n};\n\nexport default class Postgres extends SchemaGenerator {\n  typeForColumn(column) {\n    return TYPES[column.type] || 'text';\n  }\n\n  transformToText(columnName) {\n    return fmt('CAST(%s AS text)', columnName);\n  }\n\n  // alternate:\n  // select '-1.2e10' ~ '^[-+]?[0-9]*\\.?[0-9]+([eE][-+]?[0-9]+)?$';\n  transformToDouble(columnName) {\n    return fmt('convert_to_float(%s)', columnName);\n  }\n\n  primaryKeyName(table) {\n    return this.escape(this.tablePrefix + table.name + '_pkey');\n  }\n\n  primaryKeySequenceName(table) {\n    return this.escape(this.tablePrefix + table.name + '_id_seq');\n  }\n\n  primaryKey(table) {\n    if (table.columns[0].type === 'pk') {\n      return fmt('CONSTRAINT %s PRIMARY KEY (%s)',\n                 this.primaryKeyName(table),\n                 table.columns[0].name);\n    }\n\n    return '';\n  }\n\n  primarySequenceKey(table) {\n    if (table.columns[0].type === 'pk') {\n      return fmt('CONSTRAINT %s PRIMARY KEY (%s)',\n                 this.primaryKeyName(table),\n                 table.columns[0].name);\n    }\n\n    return '';\n  }\n\n  createTable(change) {\n    return fmt('CREATE TABLE IF NOT EXISTS %s (\\n  %s\\n);',\n               this.tableName(change.newTable),\n               this.columnsForTable(change.newTable).concat(this.primaryKey(change.newTable)).join(',\\n  '));\n  }\n\n  createIndex(change) {\n    const method = change.method || 'btree';\n    const indexName = this.indexName(change.newTable, change.columns);\n    const tableName = this.tableName(change.newTable);\n    const columns = change.columns.join(', ');\n    const unique = change.unique ? 'UNIQUE ' : '';\n\n    return fmt('CREATE %sINDEX %s ON %s USING %s (%s);',\n               unique, indexName, tableName, method, columns);\n  }\n\n  dropTable(change) {\n    return fmt('DROP TABLE IF EXISTS %s%s CASCADE;',\n               this.escapedSchema(),\n               this.escape(this.tablePrefix + change.oldTable.name));\n  }\n\n  renameTable(change) {\n    const parts = [ super.renameTable(change) ];\n\n    parts.push(fmt('ALTER TABLE %s RENAME CONSTRAINT %s TO %s;',\n                   this.tableName(change.newTable),\n                   this.primaryKeyName(change.oldTable),\n                   this.primaryKeyName(change.newTable)));\n\n    parts.push(fmt('ALTER SEQUENCE %s RENAME TO %s;',\n                   this.primaryKeySequenceName(change.oldTable),\n                   this.primaryKeySequenceName(change.newTable)));\n\n    return parts;\n  }\n\n  createView(change) {\n    const viewName = this.viewName(change.newView);\n    const tableName = this.tableName(change.newView.table);\n    const viewDefinition = this.projectionForView(change.newView);\n    const clause = change.newView.clause ? ' ' + change.newView.clause : '';\n\n    return fmt('CREATE OR REPLACE VIEW %s AS\\nSELECT\\n  %s\\nFROM %s%s;',\n               viewName, viewDefinition.join(',\\n  '), tableName, clause);\n  }\n}\n"]}