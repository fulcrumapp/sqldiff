{"version":3,"sources":["../../src/generators/mssql.js"],"names":["TYPES","pk","string","integer","date","time","double","timestamp","geometry","json","array","boolean","fts","MSSQL","identifier","length","replace","column","type","test","name","columnName","change","tableName","newTable","columnsForTable","join","columnDefinition","whereClause","newView","filter","parts","Object","keys","field","push","escape","viewName","projectionForView","table","method","indexName","columns","map","c","unique","spatial","escapedSchema","tablePrefix","oldTable","unescape","oldColumn","newColumn","into","from","SchemaGenerator"],"mappings":";;;;;;;;;;AAAA;;;;AACA;;;;;;;;;;AAEA,IAAMA,QAAQ;AACZC,MAAI,2CADQ;AAEZC,UAAQ,cAFI;AAGZC,WAAS,QAHG;AAIZC,QAAM,MAJM;AAKZC,QAAM,MALM;AAMZC,UAAQ,OANI;AAOZC,aAAW,UAPC;AAQZC,YAAU,WARE;AASZC,QAAM,cATM;AAUZC,SAAO,cAVK;AAWZC,WAAS,KAXG;AAYZC,OAAK;AAZO,CAAd;;IAeqBC,K;;;;;;;;;;;2BACZC,U,EAAY;AACjB,UAAIA,cAAc,IAAd,IAAsBA,WAAWC,MAAX,KAAsB,CAAhD,EAAmD;AACjD,eAAO,EAAP;AACD;;AAED,aAAO,MAAMD,UAAN,GAAmB,GAA1B;AACD;;;6BAEQA,U,EAAY;AACnB,aAAOA,WAAWE,OAAX,CAAmB,SAAnB,EAA8B,EAA9B,CAAP;AACD;;;kCAEaC,M,EAAQ;AACpB,UAAIA,OAAOC,IAAP,KAAgB,QAApB,EAA8B;AAC5B,YAAI,OAAOC,IAAP,CAAYF,OAAOG,IAAnB,KAA4BH,OAAOF,MAAP,IAAiB,IAAjD,EAAuD;AACrD,iBAAO,cAAcE,OAAOF,MAAP,IAAiB,KAA/B,IAAwC,GAA/C;AACD;AACF;;AAED,aAAOf,MAAMiB,OAAOC,IAAb,KAAsB,cAA7B;AACD;;;oCAEeG,U,EAAY;AAC1B,aAAO,kBAAI,0BAAJ,EAAgCA,UAAhC,CAAP;AACD;;;sCAEiBA,U,EAAY;AAC5B,aAAO,kBAAI,8BAAJ,EAAoCA,UAApC,EAAgDA,UAAhD,CAAP;AACD;;;gCAEWC,M,EAAQ;AAClB,aAAO,kBAAI,6BAAJ,EACI,KAAKC,SAAL,CAAeD,OAAOE,QAAtB,CADJ,EAEI,KAAKC,eAAL,CAAqBH,OAAOE,QAA5B,EAAsCE,IAAtC,CAA2C,OAA3C,CAFJ,CAAP;AAGD;;;8BAESJ,M,EAAQ;AAChB,aAAO,kBAAI,wBAAJ,EACI,KAAKC,SAAL,CAAeD,OAAOE,QAAtB,CADJ,EAEI,KAAKG,gBAAL,CAAsBL,OAAOL,MAA7B,CAFJ,CAAP;AAGD;;;+BAEUK,M,EAAQ;AACjB,UAAIM,cAAc,EAAlB;;AAEA,UAAIN,OAAOO,OAAP,CAAeC,MAAnB,EAA2B;AACzB,YAAMC,QAAQ,EAAd;;AADyB;AAAA;AAAA;;AAAA;AAGzB,+BAAoBC,OAAOC,IAAP,CAAYX,OAAOO,OAAP,CAAeC,MAA3B,CAApB,8HAAwD;AAAA,gBAA7CI,KAA6C;;AACtDH,kBAAMI,IAAN,CAAW,KAAKC,MAAL,CAAYF,KAAZ,IAAqB,MAArB,GAA8BZ,OAAOO,OAAP,CAAeC,MAAf,CAAsBI,KAAtB,CAA9B,GAA6D,GAAxE;AACD;AALwB;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;;AAOzBN,sBAAc,YAAYG,MAAML,IAAN,CAAW,OAAX,CAA1B;AACD;;AAED,aAAO,kBAAI,6CAAJ,EACI,KAAKW,QAAL,CAAcf,OAAOO,OAArB,CADJ,EAEI,KAAKS,iBAAL,CAAuBhB,OAAOO,OAA9B,EAAuCH,IAAvC,CAA4C,OAA5C,CAFJ,EAGI,KAAKH,SAAL,CAAeD,OAAOO,OAAP,CAAeU,KAA9B,CAHJ,EAIIX,WAJJ,CAAP;AAKD;;;gCAEWN,M,EAAQ;AAAA;;AAClB,UAAMkB,SAASlB,OAAOkB,MAAP,IAAiB,OAAhC;AACA,UAAMC,YAAY,KAAKA,SAAL,CAAenB,OAAOE,QAAtB,EAAgCF,OAAOoB,OAAvC,CAAlB;AACA,UAAMnB,YAAY,KAAKA,SAAL,CAAeD,OAAOE,QAAtB,CAAlB;AACA,UAAMkB,UAAUpB,OAAOoB,OAAP,CAAeC,GAAf,CAAmB;AAAA,eAAK,OAAKP,MAAL,CAAYQ,CAAZ,CAAL;AAAA,OAAnB,EAAwClB,IAAxC,CAA6C,IAA7C,CAAhB;AACA,UAAMmB,SAASvB,OAAOuB,MAAP,GAAgB,SAAhB,GAA4B,EAA3C;;AAEA,UAAMC,UAAUN,WAAW,SAAX,GAAuB,UAAvB,GAAoC,EAApD;;AAEA,aAAO,kBAAI,iCAAJ,EACIM,OADJ,EACaD,MADb,EACqBJ,SADrB,EACgClB,SADhC,EAC2CmB,OAD3C,CAAP;AAED;;;8BAESpB,M,EAAQ;AAChB,aAAO,kBAAI,4BAAJ,EACI,KAAKyB,aAAL,EADJ,EAEI,KAAKX,MAAL,CAAY,KAAKY,WAAL,GAAmB1B,OAAO2B,QAAP,CAAgB7B,IAA/C,CAFJ,CAAP;AAGD;;;gCAEWE,M,EAAQ;AAClB,aAAO,kBAAI,4CAAJ,EACJ,KAAK4B,QAAL,CAAc,KAAK3B,SAAL,CAAeD,OAAO2B,QAAtB,CAAd,CADI,EAEJ,KAAKD,WAAL,GAAmB1B,OAAOE,QAAP,CAAgBJ,IAF/B,CAAP;AAGD;;;iCAEYE,M,EAAQ;AACnB,aAAO,kBAAI,4CAAJ,EACJ,CAAC,KAAK4B,QAAL,CAAc,KAAK3B,SAAL,CAAeD,OAAOE,QAAtB,CAAd,CAAD,EAAiDF,OAAO6B,SAAP,CAAiB/B,IAAlE,EAAwEM,IAAxE,CAA6E,GAA7E,CADI,EAEJJ,OAAO8B,SAAP,CAAiBhC,IAFb,CAAP;AAGD;;;+BAEUiC,I,EAAMC,I,EAAM;AACrB,UAAMvB,QAAQ,CACZ,kBAAI,4BAAJ,EAAkC,KAAKR,SAAL,CAAe8B,IAAf,CAAlC,CADY,2GAEKA,IAFL,EAEWC,IAFX,GAGZ,kBAAI,6BAAJ,EAAmC,KAAK/B,SAAL,CAAe8B,IAAf,CAAnC,CAHY,EAIZ,kBAAI,2BAAJ,EAAiC,KAAK9B,SAAL,CAAe8B,IAAf,CAAjC,CAJY,CAAd;;AAOA,aAAOtB,KAAP;AACD;;;;EAvGgCwB,yB;;kBAAd1C,K","file":"mssql.js","sourcesContent":["import SchemaGenerator from '../schema-generator';\nimport {format as fmt} from 'util';\n\nconst TYPES = {\n  pk: 'bigint NOT NULL IDENTITY(1,1) PRIMARY KEY',\n  string: 'varchar(max)',\n  integer: 'bigint',\n  date: 'date',\n  time: 'time',\n  double: 'float',\n  timestamp: 'datetime',\n  geometry: 'geography',\n  json: 'varchar(max)',\n  array: 'varchar(max)',\n  boolean: 'bit',\n  fts: 'varchar(max)'\n};\n\nexport default class MSSQL extends SchemaGenerator {\n  escape(identifier) {\n    if (identifier == null || identifier.length === 0) {\n      return '';\n    }\n\n    return '[' + identifier + ']';\n  }\n\n  unescape(identifier) {\n    return identifier.replace(/[\\[\\]]/g, '');\n  }\n\n  typeForColumn(column) {\n    if (column.type === 'string') {\n      if (/_id$/.test(column.name) || column.length != null) {\n        return 'varchar(' + (column.length || '100') + ')';\n      }\n    }\n\n    return TYPES[column.type] || 'varchar(max)';\n  }\n\n  transformToText(columnName) {\n    return fmt('CAST(%s AS varchar(max))', columnName);\n  }\n\n  transformToDouble(columnName) {\n    return fmt('IIF(ISNUMERIC(%s), %s, NULL)', columnName, columnName);\n  }\n\n  createTable(change) {\n    return fmt('CREATE TABLE %s (\\n  %s\\n);',\n               this.tableName(change.newTable),\n               this.columnsForTable(change.newTable).join(',\\n  '));\n  }\n\n  addColumn(change) {\n    return fmt('ALTER TABLE %s ADD %s;',\n               this.tableName(change.newTable),\n               this.columnDefinition(change.column));\n  }\n\n  createView(change) {\n    let whereClause = '';\n\n    if (change.newView.filter) {\n      const parts = [];\n\n      for (const field of Object.keys(change.newView.filter)) {\n        parts.push(this.escape(field) + \" = '\" + change.newView.filter[field] + \"'\");\n      }\n\n      whereClause = ' WHERE ' + parts.join(' AND ');\n    }\n\n    return fmt('CREATE VIEW %s AS\\nSELECT\\n  %s\\nFROM %s%s;',\n               this.viewName(change.newView),\n               this.projectionForView(change.newView).join(',\\n  '),\n               this.tableName(change.newView.table),\n               whereClause);\n  }\n\n  createIndex(change) {\n    const method = change.method || 'btree';\n    const indexName = this.indexName(change.newTable, change.columns);\n    const tableName = this.tableName(change.newTable);\n    const columns = change.columns.map(c => this.escape(c)).join(', ');\n    const unique = change.unique ? 'UNIQUE ' : '';\n\n    const spatial = method === 'spatial' ? ' SPATIAL' : '';\n\n    return fmt('CREATE%s %sINDEX %s ON %s (%s);',\n               spatial, unique, indexName, tableName, columns);\n  }\n\n  dropTable(change) {\n    return fmt('DROP TABLE IF EXISTS %s%s;',\n               this.escapedSchema(),\n               this.escape(this.tablePrefix + change.oldTable.name));\n  }\n\n  renameTable(change) {\n    return fmt('EXEC sp_rename \\'%s\\', \\'%s\\', \\'OBJECT\\';',\n       this.unescape(this.tableName(change.oldTable)),\n       this.tablePrefix + change.newTable.name);\n  }\n\n  renameColumn(change) {\n    return fmt('EXEC sp_rename \\'%s\\', \\'%s\\', \\'COLUMN\\';',\n       [this.unescape(this.tableName(change.newTable)), change.oldColumn.name].join('.'),\n       change.newColumn.name);\n  }\n\n  insertInto(into, from) {\n    const parts = [\n      fmt('SET IDENTITY_INSERT %s ON;', this.tableName(into)),\n      super.insertInto(into, from),\n      fmt('SET IDENTITY_INSERT %s OFF;', this.tableName(into)),\n      fmt('DBCC CHECKIDENT (\\'%s\\');', this.tableName(into))\n    ];\n\n    return parts;\n  }\n}\n"]}